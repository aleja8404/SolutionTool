<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Clasificación de Clientes</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f4f6f9;
            color: #333;
        }

        .dashboard-container {
            padding: 30px 15px;
            max-width: 100%;
            overflow-x: hidden;
        }

        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin: 0 auto;
            max-width: 1400px;
            width: 100%;
            transition: transform 0.3s ease;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 20px;
            text-align: center;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
            width: 100%;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-height: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chart-container {
            flex: 1;
            min-height: 350px;
            position: relative;
            width: 100%;
            max-width: 500px;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
            min-height: 350px;
            max-height: 380px;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #fff;
        }

        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: linear-gradient(135deg, #343a40, #23272b);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        td {
            font-size: 0.95rem;
            color: #444;
        }

        .btn-back, .btn-export, .btn-enlarge, .btn-apply-filter {
            display: inline-block;
            padding: 10px 20px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn-back {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .btn-export {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .btn-enlarge {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .btn-apply-filter {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .interactive-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            height: 100%;
            overflow-y: auto;
        }

        .filter-item {
            min-width: 200px;
            margin-bottom: 10px;
        }

        .filter-item label {
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

        .filter-item select, .filter-item input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .page-item {
            margin: 0 5px;
        }

        .page-link {
            border-radius: 8px;
            padding: 8px 16px;
            color: #0078D4;
            border: 1px solid #0078D4;
            background-color: #fff;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .page-link:hover {
            background-color: #E6F0FA;
            color: #005BA1;
            border-color: #005BA1;
        }

        .page-item.active .page-link {
            background-color: #0078D4;
            color: #fff;
            border-color: #0078D4;
        }

        .page-item.disabled .page-link {
            color: #A0A0A0;
            border-color: #A0A0A0;
            background-color: #F5F5F5;
            cursor: not-allowed;
        }

        .modal-content {
            border-radius: 12px;
        }

        .modal-body {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 20px;
        }

        .modal-chart-container {
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-filters-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .modal-canvas {
            width: 100% !important;
            height: 600px !important;
            max-width: 800px;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 20px 10px;
            }

            .card {
                padding: 20px;
            }

            .charts-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .chart-card {
                padding: 20px;
                min-height: 380px;
            }

            .chart-container {
                min-height: 300px;
                max-width: 400px;
            }

            canvas {
                min-height: 300px;
                max-height: 350px;
            }

            th, td {
                padding: 10px;
                font-size: 0.85rem;
            }

            .modal-body {
                flex-direction: column;
            }

            .modal-canvas {
                height: 400px !important;
            }

            .modal-filters-container {
                max-height: 300px;
            }

            .interactive-filters {
                flex-direction: column;
            }

            .filter-item {
                min-width: 100%;
            }
        }

        @media (max-width: 576px) {
            h1 {
                font-size: 1.5rem;
            }

            .chart-card {
                min-height: 320px;
                padding: 15px;
            }

            .chart-container {
                min-height: 280px;
                max-width: 300px;
            }

            canvas {
                min-height: 250px;
                max-height: 300px;
            }

            .modal-canvas {
                height: 300px !important;
            }
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" th:href="@{/admin/dashboard}">Administrador</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" th:href="@{/clientes}">Clientes</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/usuarios}">Usuarios</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/order-items}">Órdenes</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/categorias}">Categorías</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/productos}">Productos</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/ventas}">Ventas</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/compras}">Compras</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/proveedores}"> Proveedores</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/vendedores}">Vendedores</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/vendedor-producto}">Vendedor Artículo</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/clasificacion}">Clasificación de Clientes</a></li>
        </ul>
        <a class="btn btn-outline-light" style="--bs-btn-line-height: 1.0;" th:href="@{/logout}">Cerrar Sesión</a>
    </div>
</nav>

<div class="dashboard-container">
    <h1>Clasificación de Clientes</h1>
    <div class="card">
        <!-- Buttons -->
        <div class="d-flex justify-content-between mb-3">
            <a class="btn-back" th:href="@{/clasificacion}">Volver al Formulario</a>
            <a class="btn-export" th:href="@{/clasificacion/export(edadMin=${edadMin},edadMax=${edadMax},frecuenciaCompraMin=${frecuenciaCompraMin},frecuenciaCompraMax=${frecuenciaCompraMax},valorTotalCompraMin=${valorTotalCompraMin},valorTotalCompraMax=${valorTotalCompraMax},ultimaCompraMin=${ultimaCompraMin},ultimaCompraMax=${ultimaCompraMax},metodoPago=${metodoPago},categoriaCliente=${categoriaCliente})}">
                <i class="fas fa-file-excel"></i> Exportar Todo
            </a>
        </div>

        <!-- Charts -->
        <div class="charts-row">
            <div class="chart-card">
                <h3>Distribución por Categoría de Cliente</h3>
                <div class="chart-container">
                    <canvas id="categoriaChart"></canvas>
                </div>
                <button class="btn-enlarge mt-3" data-bs-toggle="modal" data-bs-target="#chartModal" data-chart="categoriaChart">Ver en Grande</button>
            </div>
            <div class="chart-card">
                <h3>Distribución por Método de Pago</h3>
                <div class="chart-container">
                    <canvas id="metodoPagoChart"></canvas>
                </div>
                <button class="btn-enlarge mt-3" data-bs-toggle="modal" data-bs-target="#chartModal" data-chart="metodoPagoChart">Ver en Grande</button>
            </div>
            <div class="chart-card">
                <h3>Valor Total de Compra Promedio por Rango de Edad</h3>
                <div class="chart-container">
                    <canvas id="valorTotalCompraChart"></canvas>
                </div>
                <button class="btn-enlarge mt-3" data-bs-toggle="modal" data-bs-target="#chartModal" data-chart="valorTotalCompraChart">Ver en Grande</button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table id="predictionsTable">
                <thead>
                <tr>
                    <th>Edad</th>
                    <th>Frecuencia de Compra</th>
                    <th>Valor Total de Compra (COP)</th>
                    <th>Días desde Última Compra</th>
                    <th>Método de Pago</th>
                    <th>Resultado de la Clasificación</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="prediction : ${predictions.content}">
                    <td th:text="${prediction.edad}"></td>
                    <td th:text="${prediction.frecuenciaCompra}"></td>
                    <td th:text="'$' + ${#numbers.formatDecimal(prediction.valorTotalCompra, 1, 2, 'COMMA')}"></td>
                    <td th:text="${prediction.ultimaCompra}"></td>
                    <td th:text="${prediction.metodoPago}"></td>
                    <td>
                        <span th:text="'Categoría: ' + ${prediction.categoriaCliente}"></span><br/>
                        <span th:text="'Confianza: ' + (${prediction.confianza != null} ? ${#numbers.formatDecimal(prediction.confianza, 1, 1, 'COMMA')} + '%' : 'N/A')"></span>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(predictions.content)}">
                    <td colspan="6" class="empty-message">No hay clasificaciones disponibles.</td>
                </tr>
                </tbody>
            </table>

            <!-- Simplified Pagination -->
            <div class="pagination-container" th:if="${predictions.totalPages > 0}">
                <nav>
                    <ul class="pagination">
                        <li class="page-item" th:class="${predictions.number == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/clasificacion/lista(page=${predictions.number - 1},size=${pageSize},edadMin=${edadMin},edadMax=${edadMax},frecuenciaCompraMin=${frecuenciaCompraMin},frecuenciaCompraMax=${frecuenciaCompraMax},valorTotalCompraMin=${valorTotalCompraMin},valorTotalCompraMax=${valorTotalCompraMax},ultimaCompraMin=${ultimaCompraMin},ultimaCompraMax=${ultimaCompraMax},metodoPago=${metodoPago},categoriaCliente=${categoriaCliente})}">Anterior</a>
                        </li>
                        <li class="page-item active">
                            <span class="page-link" th:text="${predictions.number + 1}"></span>
                        </li>
                        <li class="page-item" th:class="${predictions.number == predictions.totalPages - 1} ? 'disabled'">
                            <a class="page-link" th:href="@{/clasificacion/lista(page=${predictions.number + 1},size=${pageSize},edadMin=${edadMin},edadMax=${edadMax},frecuenciaCompraMin=${frecuenciaCompraMin},frecuenciaCompraMax=${frecuenciaCompraMax},valorTotalCompraMin=${valorTotalCompraMin},valorTotalCompraMax=${valorTotalCompraMax},ultimaCompraMin=${ultimaCompraMin},ultimaCompraMax=${ultimaCompraMax},metodoPago=${metodoPago},categoriaCliente=${categoriaCliente})}">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Enlarged Chart -->
<div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartModalLabel">Gráfico Ampliado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-chart-container">
                    <canvas id="enlargedChart" class="modal-canvas"></canvas>
                </div>
                <div class="modal-filters-container">
                    <!-- Interactive Filters (Power BI Style) -->
                    <div class="interactive-filters">
                        <div class="filter-item">
                            <label for="filterEdadMin">Edad Mínima</label>
                            <input type="number" id="filterEdadMin" class="form-control" value="">
                        </div>
                        <div class="filter-item">
                            <label for="filterEdadMax">Edad Máxima</label>
                            <input type="number" id="filterEdadMax" class="form-control" value="">
                        </div>
                        <div class="filter-item">
                            <label for="filterFrecuenciaCompraMin">Frec. Compra Mín.</label>
                            <input type="number" id="filterFrecuenciaCompraMin" class="form-control" value="">
                        </div>
                        <div class="filter-item">
                            <label for="filterFrecuenciaCompraMax">Frec. Compra Máx.</label>
                            <input type="number" id="filterFrecuenciaCompraMax" class="form-control" value="">
                        </div>
                        <div class="filter-item">
                            <label for="filterValorTotalCompraMin">Valor Total Mín. (COP)</label>
                            <input type="number" step="0.01" id="filterValorTotalCompraMin" class="form-control" value="">
                        </div>
                        <div class="filter-item">
                            <label for="filterValorTotalCompraMax">Valor Total Máx. (COP)</label>
                            <input type="number" step="0.01" id="filterValorTotalCompraMax" class="form-control" value="">
                        </div>
                        <div class="filter-item">
                            <label for="filterUltimaCompraMin">Días Últ. Compra Mín.</label>
                            <input type="number" id="filterUltimaCompraMin" class="form-control" value="">
                        </div>
                        <div class="filter-item">
                            <label for="filterUltimaCompraMax">Días Últ. Compra Máx.</label>
                            <input type="number" id="filterUltimaCompraMax" class="form-control" value="">
                        </div>
                        <div class="filter-item">
                            <label for="filterMetodoPago">Método de Pago</label>
                            <select id="filterMetodoPago" class="form-control">
                                <option value="">Todos</option>
                                <option th:each="metodo : ${metodoPagoList}" th:value="${metodo}" th:text="${metodo}"></option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="filterCategoriaCliente">Categoría</label>
                            <select id="filterCategoriaCliente" class="form-control">
                                <option value="">Todos</option>
                                <option th:each="categoria : ${categoriaClienteList}" th:value="${categoria}" th:text="${categoria}"></option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <button type="button" class="btn-apply-filter" id="applyFilters">Aplicar Filtros</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/webjars/jquery/3.6.0/jquery.min.js}"></script>
<script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">
    $(document).ready(function() {
        // Pass Thymeleaf variables to JavaScript
        const originalCategoriaClienteCounts = /*[[${categoriaClienteCounts}]]*/ {};
        const originalMetodoPagoCounts = /*[[${metodoPagoCounts}]]*/ {};
        const originalAvgValorTotalCompraByEdad = /*[[${avgValorTotalCompraByEdad}]]*/ {
            "20-29": 515000,
            "40-49": 8000000,
            ">20": 450000
        };
        const originalPredictions = /*[[${predictions.content}]]*/ [];

        let categoriaClienteCounts = { ...originalCategoriaClienteCounts };
        let metodoPagoCounts = { ...originalMetodoPagoCounts };
        let avgValorTotalCompraByEdad = { ...originalAvgValorTotalCompraByEdad };
        let predictions = [...originalPredictions];

        // Colombian number formatter
        const formatter = new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });

        // Store chart configurations
        const chartConfigs = {
            categoriaChart: {
                type: 'bar',
                data: {
                    labels: Object.keys(categoriaClienteCounts),
                    datasets: [{
                        label: 'Cantidad',
                        data: Object.values(categoriaClienteCounts),
                        backgroundColor: '#0078D4',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Cantidad de clientes', font: { size: 12 } },
                            grid: { display: false },
                            ticks: {
                                callback: function(value) {
                                    return value;
                                },
                                mirror: true,
                                z: 1,
                                font: { size: 10 }
                            }
                        },
                        x: {
                            title: { display: true, text: 'Categoría de cliente', font: { size: 12 } },
                            grid: { display: false },
                            ticks: {
                                mirror: true,
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Cantidad: ${context.parsed.y}`;
                                }
                            }
                        },
                        datalabels: { display: false }
                    },
                    layout: {
                        padding: 20
                    }
                },
                plugins: [{
                    id: 'showBarValues',
                    afterDatasetsDraw(chart, args, options) {
                        const {ctx, data, chartArea: {top, bottom, left, right, width, height}, scales: {x, y}} = chart;
                        ctx.font = '12px Inter';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.fillStyle = '#333';
                        data.datasets.forEach((dataset, i) => {
                            chart.getDatasetMeta(i).data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                ctx.fillText(value, bar.x, bar.y - 5);
                            });
                        });
                    }
                }],
                modalOptions: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Cantidad de clientes', font: { size: 16 } },
                            grid: { display: false },
                            ticks: {
                                callback: function(value) {
                                    return value;
                                },
                                font: { size: 14 }
                            }
                        },
                        x: {
                            title: { display: true, text: 'Categoría de cliente', font: { size: 16 } },
                            grid: { display: false },
                            ticks: {
                                font: { size: 14 }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Cantidad: ${context.parsed.y}`;
                                }
                            },
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 }
                        },
                        datalabels: { display: false }
                    },
                    layout: {
                        padding: 30
                    }
                }
            },
            metodoPagoChart: {
                type: 'pie',
                data: {
                    labels: Object.keys(metodoPagoCounts),
                    datasets: [{
                        data: Object.values(metodoPagoCounts),
                        backgroundColor: ['#007185', '#f0c14b', '#28a745', '#dc3545', '#6610f2', '#fd7e14']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 12 },
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            },
                            bodyFont: { size: 12 }
                        },
                        datalabels: { display: false }
                    },
                    layout: {
                        padding: 20
                    }
                },
                plugins: [{
                    id: 'showPieValues',
                    afterDatasetsDraw(chart, args, options) {
                        const {ctx, data, chartArea: {top, bottom, left, right, width, height}} = chart;
                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                        const centerX = (left + right) / 2;
                        const centerY = (top + bottom) / 2;
                        const radius = Math.min(width, height) / 2;
                        ctx.font = '12px Inter';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        chart.getDatasetMeta(0).data.forEach((arc, i) => {
                            const angle = arc.startAngle + (arc.endAngle - arc.startAngle) / 2;
                            const value = data.datasets[0].data[i];
                            const percentage = Math.round((value / total) * 100);
                            const x = centerX + (radius * 0.7) * Math.cos(angle);
                            const y = centerY + (radius * 0.7) * Math.sin(angle);
                            const bgColor = data.datasets[0].backgroundColor[i];
                            const r = parseInt(bgColor.slice(1, 3), 16);
                            const g = parseInt(bgColor.slice(3, 5), 16);
                            const b = parseInt(bgColor.slice(5, 7), 16);
                            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                            ctx.fillStyle = brightness > 128 ? '#333' : '#fff';
                            ctx.fillText(`${percentage}%`, x, y);
                        });
                    }
                }],
                modalOptions: {
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 16 },
                                usePointStyle: true,
                                padding: 20,
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            },
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 }
                        },
                        datalabels: { display: false }
                    },
                    layout: {
                        padding: 30
                    }
                },
                modalPlugins: [{
                    id: 'showPieValues',
                    afterDatasetsDraw(chart, args, options) {
                        const {ctx, data, chartArea: {top, bottom, left, right, width, height}} = chart;
                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                        const centerX = (left + right) / 2;
                        const centerY = (top + bottom) / 2;
                        const radius = Math.min(width, height) / 2;
                        ctx.font = '16px Inter';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        chart.getDatasetMeta(0).data.forEach((arc, i) => {
                            const angle = arc.startAngle + (arc.endAngle - arc.startAngle) / 2;
                            const value = data.datasets[0].data[i];
                            const percentage = Math.round((value / total) * 100);
                            const x = centerX + (radius * 0.7) * Math.cos(angle);
                            const y = centerY + (radius * 0.7) * Math.sin(angle);
                            const bgColor = data.datasets[0].backgroundColor[i];
                            const r = parseInt(bgColor.slice(1, 3), 16);
                            const g = parseInt(bgColor.slice(3, 5), 16);
                            const b = parseInt(bgColor.slice(5, 7), 16);
                            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                            ctx.fillStyle = brightness > 128 ? '#333' : '#fff';
                            ctx.fillText(`${percentage}%`, x, y);
                        });
                    }
                }]
            },
            valorTotalCompraChart: {
                type: 'line',
                data: {
                    labels: Object.keys(avgValorTotalCompraByEdad),
                    datasets: [{
                        label: 'Valor Promedio',
                        data: Object.values(avgValorTotalCompraByEdad),
                        borderColor: '#FFC107',
                        backgroundColor: 'rgba(255, 245, 204, 0.5)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#005EB8',
                        pointBorderColor: '#005EB8',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointHoverBorderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 8000000,
                            title: { display: true, text: 'Valor Total Promedio (COP)', font: { size: 12 } },
                            ticks: {
                                callback: function(value) {
                                    return formatter.format(value);
                                },
                                mirror: true,
                                font: { size: 10 },
                                stepSize: 2000000
                            },
                            grid: {
                                drawBorder: false,
                                color: '#e9ecef'
                            },
                            padding: 10
                        },
                        x: {
                            title: { display: true, text: 'Rango de Edad', font: { size: 12 } },
                            ticks: {
                                mirror: true,
                                font: { size: 10 }
                            },
                            grid: {
                                display: false
                            },
                            padding: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatter.format(context.parsed.y);
                                    return label;
                                }
                            },
                            bodyFont: { size: 12 }
                        },
                        datalabels: { display: false }
                    },
                    layout: {
                        padding: 20
                    }
                },
                plugins: [{
                    id: 'showLineValues',
                    afterDatasetsDraw(chart, args, options) {
                        const {ctx, data, chartArea: {top, bottom, left, right, width, height}, scales: {x, y}} = chart;
                        ctx.font = '12px Inter';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.fillStyle = '#333';
                        data.datasets.forEach((dataset, i) => {
                            chart.getDatasetMeta(i).data.forEach((point, index) => {
                                const value = dataset.data[index];
                                ctx.fillText(formatter.format(value), point.x, point.y - 10);
                            });
                        });
                    }
                }],
                modalOptions: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 8000000,
                            title: { display: true, text: 'Valor Total Promedio (COP)', font: { size: 16 } },
                            ticks: {
                                callback: function(value) {
                                    return formatter.format(value);
                                },
                                font: { size: 14 },
                                stepSize: 2000000
                            },
                            grid: {
                                drawBorder: false,
                                color: '#e9ecef'
                            },
                            padding: 20
                        },
                        x: {
                            title: { display: true, text: 'Rango de Edad', font: { size: 16 } },
                            ticks: {
                                font: { size: 14 }
                            },
                            grid: {
                                display: false
                            },
                            padding: 20
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatter.format(context.parsed.y);
                                    return label;
                                }
                            },
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 }
                        },
                        datalabels: { display: false }
                    },
                    layout: {
                        padding: 30
                    }
                },
                modalPlugins: [{
                    id: 'showLineValues',
                    afterDatasetsDraw(chart, args, options) {
                        const {ctx, data, chartArea: {top, bottom, left, right, width, height}, scales: {x, y}} = chart;
                        ctx.font = '16px Inter';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.fillStyle = '#333';
                        data.datasets.forEach((dataset, i) => {
                            chart.getDatasetMeta(i).data.forEach((point, index) => {
                                const value = dataset.data[index];
                                ctx.fillText(formatter.format(value), point.x, point.y - 15);
                            });
                        });
                    }
                }]
            }
        };

        // Initialize charts
        const categoriaChart = new Chart(document.getElementById('categoriaChart').getContext('2d'), chartConfigs.categoriaChart);
        const metodoPagoChart = new Chart(document.getElementById('metodoPagoChart').getContext('2d'), chartConfigs.metodoPagoChart);
        const valorTotalCompraChart = new Chart(document.getElementById('valorTotalCompraChart').getContext('2d'), chartConfigs.valorTotalCompraChart);

        // Handle modal chart display
        $('#chartModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget);
            const chartId = button.data('chart');
            const chartConfig = chartConfigs[chartId];

            // Update modal title
            const modalTitle = {
                categoriaChart: 'Distribución por Categoría de Cliente',
                metodoPagoChart: 'Distribución por Método de Pago',
                valorTotalCompraChart: 'Valor Total de Compra Promedio por Rango de Edad'
            };
            $('#chartModalLabel').text(modalTitle[chartId]);

            // Destroy previous chart if exists
            const enlargedChartCanvas = document.getElementById('enlargedChart');
            if (enlargedChartCanvas.chart) {
                enlargedChartCanvas.chart.destroy();
            }

            // Create new chart in modal
            const ctx = enlargedChartCanvas.getContext('2d');
            enlargedChartCanvas.chart = new Chart(ctx, {
                ...chartConfig,
                options: {
                    ...chartConfig.options,
                    ...chartConfig.modalOptions,
                    maintainAspectRatio: false,
                    responsive: true
                },
                plugins: chartConfig.modalPlugins || chartConfig.plugins
            });
        });

        // Clean up chart when modal is hidden
        $('#chartModal').on('hidden.bs.modal', function () {
            const enlargedChartCanvas = document.getElementById('enlargedChart');
            if (enlargedChartCanvas.chart) {
                enlargedChartCanvas.chart.destroy();
                enlargedChartCanvas.chart = null;
            }
        });

        // Apply filters function
        function applyFilters() {
            const filterEdadMin = parseInt($('#filterEdadMin').val()) || 0;
            const filterEdadMax = parseInt($('#filterEdadMax').val()) || Infinity;
            const filterFrecuenciaCompraMin = parseInt($('#filterFrecuenciaCompraMin').val()) || 0;
            const filterFrecuenciaCompraMax = parseInt($('#filterFrecuenciaCompraMax').val()) || Infinity;
            const filterValorTotalCompraMin = parseFloat($('#filterValorTotalCompraMin').val()) || 0;
            const filterValorTotalCompraMax = parseFloat($('#filterValorTotalCompraMax').val()) || Infinity;
            const filterUltimaCompraMin = parseInt($('#filterUltimaCompraMin').val()) || 0;
            const filterUltimaCompraMax = parseInt($('#filterUltimaCompraMax').val()) || Infinity;
            const filterMetodoPago = $('#filterMetodoPago').val();
            const filterCategoriaCliente = $('#filterCategoriaCliente').val();

            // Filter predictions
            predictions = originalPredictions.filter(prediction => {
                const edad = parseInt(prediction.edad);
                const frecuenciaCompra = parseInt(prediction.frecuenciaCompra);
                const valorTotalCompra = parseFloat(prediction.valorTotalCompra);
                const ultimaCompra = parseInt(prediction.ultimaCompra);
                const metodoPagoMatch = !filterMetodoPago || prediction.metodoPago === filterMetodoPago;
                const categoriaClienteMatch = !filterCategoriaCliente || prediction.categoriaCliente === filterCategoriaCliente;
                return edad >= filterEdadMin && edad <= filterEdadMax &&
                       frecuenciaCompra >= filterFrecuenciaCompraMin && frecuenciaCompra <= filterFrecuenciaCompraMax &&
                       valorTotalCompra >= filterValorTotalCompraMin && valorTotalCompra <= filterValorTotalCompraMax &&
                       ultimaCompra >= filterUltimaCompraMin && ultimaCompra <= filterUltimaCompraMax &&
                       metodoPagoMatch && categoriaClienteMatch;
            });

            // Recalculate charts data
            categoriaClienteCounts = {};
            metodoPagoCounts = {};
            avgValorTotalCompraByEdad = {};

            predictions.forEach(prediction => {
                categoriaClienteCounts[prediction.categoriaCliente] = (categoriaClienteCounts[prediction.categoriaCliente] || 0) + 1;
                metodoPagoCounts[prediction.metodoPago] = (metodoPagoCounts[prediction.metodoPago] || 0) + 1;

                const edadRange = getEdadRange(prediction.edad);
                avgValorTotalCompraByEdad[edadRange] = avgValorTotalCompraByEdad[edadRange] || [];
                avgValorTotalCompraByEdad[edadRange].push(prediction.valorTotalCompra);
            });

            Object.keys(avgValorTotalCompraByEdad).forEach(key => {
                avgValorTotalCompraByEdad[key] = avgValorTotalCompraByEdad[key].length
                    ? Math.round(avgValorTotalCompraByEdad[key].reduce((a, b) => a + b, 0) / avgValorTotalCompraByEdad[key].length)
                    : 0;
            });

            // Update charts
            categoriaChart.data.labels = Object.keys(categoriaClienteCounts);
            categoriaChart.data.datasets[0].data = Object.values(categoriaClienteCounts);
            categoriaChart.update();

            metodoPagoChart.data.labels = Object.keys(metodoPagoCounts);
            metodoPagoChart.data.datasets[0].data = Object.values(metodoPagoCounts);
            metodoPagoChart.update();

            valorTotalCompraChart.data.labels = Object.keys(avgValorTotalCompraByEdad);
            valorTotalCompraChart.data.datasets[0].data = Object.values(avgValorTotalCompraByEdad);
            valorTotalCompraChart.update();

            // Update enlarged chart if modal is open
            const enlargedChartCanvas = document.getElementById('enlargedChart');
            if (enlargedChartCanvas.chart) {
                const chartId = $('#chartModal').find('button[data-bs-toggle="modal"]').data('chart');
                if (chartId === 'categoriaChart') {
                    enlargedChartCanvas.chart.data.labels = Object.keys(categoriaClienteCounts);
                    enlargedChartCanvas.chart.data.datasets[0].data = Object.values(categoriaClienteCounts);
                } else if (chartId === 'metodoPagoChart') {
                    enlargedChartCanvas.chart.data.labels = Object.keys(metodoPagoCounts);
                    enlargedChartCanvas.chart.data.datasets[0].data = Object.values(metodoPagoCounts);
                } else if (chartId === 'valorTotalCompraChart') {
                    enlargedChartCanvas.chart.data.labels = Object.keys(avgValorTotalCompraByEdad);
                    enlargedChartCanvas.chart.data.datasets[0].data = Object.values(avgValorTotalCompraByEdad);
                }
                enlargedChartCanvas.chart.update();
            }

            // Update table
            const tbody = $('#predictionsTable tbody');
            tbody.empty();
            if (predictions.length > 0) {
                predictions.forEach(prediction => {
                    tbody.append(`
                        <tr>
                            <td>${prediction.edad}</td>
                            <td>${prediction.frecuenciaCompra}</td>
                            <td>${formatter.format(prediction.valorTotalCompra)}</td>
                            <td>${prediction.ultimaCompra}</td>
                            <td>${prediction.metodoPago}</td>
                            <td>
                                <span>Categoría: ${prediction.categoriaCliente}</span><br/>
                                <span>Confianza: ${prediction.confianza ? formatter.format(prediction.confianza) + '%' : 'N/A'}</span>
                            </td>
                        </tr>
                    `);
                });
            } else {
                tbody.append('<tr><td colspan="6" class="empty-message">No hay clasificaciones disponibles.</td></tr>');
            }
        }

        // Helper function to determine age range
        function getEdadRange(edad) {
            edad = parseInt(edad);
            if (edad >= 20 && edad <= 29) return "20-29";
            if (edad >= 40 && edad <= 49) return "40-49";
            return ">20";
        }

        // Apply filters on button click or input change
        $('#applyFilters').on('click', applyFilters);
        $('.interactive-filters input, .interactive-filters select').on('change', applyFilters);

        // Initial apply to reflect server-side filters
        applyFilters();
    });
</script>
</body>
</html>